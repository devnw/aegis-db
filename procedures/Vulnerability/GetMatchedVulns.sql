/*
  RETURN VulnerabilityMatch
  FirstID                 NVARCHAR(255)     NOT
  FirstTitle              NVARCHAR(255)     NOT
  SecondID                NVARCHAR(255)     NOT
  SecondTitle             NVARCHAR(255)     NOT
  MatchConfidence         INT               NOT
  MatchReason             NVARCHAR(255)     NOT
  VulnerabilityID         NVARCHAR(36)               NOT
*/

DROP PROCEDURE IF EXISTS `GetMatchedVulns`;

CREATE PROCEDURE `GetMatchedVulns` ()
  #BEGIN#
  SELECT
    F.SourceVulnId,
    F.Title,
    S.SourceVulnId,
    S.Title,
    F.MatchConfidence,
    F.MatchReasons,
    F.VulnerabilityId
  FROM VulnerabilityInfo F
    JOIN VulnerabilityInfo S
    JOIN Source FS ON FS.Id = F.SourceId
    JOIN Source SS ON SS.Id = S.SourceId
  WHERE F.VulnerabilityId IS NOT NULL AND F.VulnerabilityId = S.VulnerabilityId AND F.SourceId != S.SourceId
        AND FS.Source = 'Nexpose' AND SS.Source = 'Qualys';