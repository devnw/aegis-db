/*
  RETURN VulnerabilityInfo SINGLE
  ID                      VARCHAR(36)               NOT
  SourceVulnID            NVARCHAR(255)     NOT
  VulnerabilityID         VARCHAR(36)               NULL
  SourceID                VARCHAR(36)               NOT
  CVSSScore                    FLOAT             NOT
  CVSS3Score                   FLOAT             NULL
  Description             TEXT              NOT
  Solution                MEDIUMTEXT        NOT
  Created                 DATETIME          NULL
  Updated                 DATETIME          NULL
  NeedsUpdate             BIT               NOT
*/

DROP PROCEDURE IF EXISTS `GetVulnInfoBySourceVulnIDSourceID`;

CREATE PROCEDURE `GetVulnInfoBySourceVulnIDSourceID` (_SourceVulnID NVARCHAR(255), _SourceID VARCHAR(36), _Modified DATETIME)
  #BEGIN#
  SELECT
    VI.Id,
    VI.SourceVulnId,
    VI.VulnerabilityId,
    VI.SourceId,
    VI.CVSS,
    VI.CVSS3,
    VI.Description,
    VI.Solution,
    VI.Created,
    VI.Updated,
    CASE
    WHEN (VI.Updated IS NULL AND VI.Created < _Modified) OR VI.Updated < _Modified THEN b'1' -- modified was after created/updated
    ELSE b'0' -- if the last modified was in the past we don't need to update
    END AS NeedsUpdate
  FROM VulnerabilityInfo VI
    WHERE VI.SourceId = _SourceID AND VI.SourceVulnId = _SourceVulnID;